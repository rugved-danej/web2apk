name: Build and Release APK

on:
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Dependencies
        run: npm install

      # Checks if you provided a custom icon and generates Android sizes
      - name: Generate App Icons
        run: |
          if [ -f "assets/icon.png" ]; then
            echo "Icon found, generating Android resources..."
            npx capacitor-assets generate --android
          else
            echo "No custom icon found in assets/icon.png, skipping..."
          fi

      - name: Sync Web Assets to Android
        run: npx cap sync android

      - name: Build Android APK (Debug)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Rename APK for Release
        run: |
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/webtoapk.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: webtoapk
          name: Pre-Release webtoapk
          body: "Automated build. Latest changes from `www` and `assets`."
          draft: false
          prerelease: true
          files: |
            android/app/build/outputs/apk/debug/webtoapk.apk
